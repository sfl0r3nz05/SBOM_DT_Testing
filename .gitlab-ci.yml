stages:
  - check
  #- build
  - test

security-check:
  stage: check
  image:
   name: aquasec/trivy:latest
   entrypoint: [""] 
  tags:
    - sbom
  script:
  - trivy --insecure --scanners vuln --format cyclonedx --output source.json fs .
  artifacts:
    paths:
      - source.json

#build:
#  stage: build
#  image: 
#    name: aquasec/trivy:latest
#    entrypoint: [""]
#  tags:
#    - sbom
#  script:
#    - echo "Building Docker image..."
#    - docker build -t vulnerable-flask-app:0.1 .

security_scan:
  stage: test
  image: 
    name: aquasec/trivy:latest
    entrypoint: [""]
  tags:
    - sbom
  before_script:
    - mkdir -p /root/.docker
    - |
      cat << 'EOF' > /root/.docker/config.json
      {
        "insecure-registries": [
          "192.168.64.138:5000"
        ]
      }
      EOF
  script:
    - apk add --no-cache docker-cli
    - docker pull localhost:5000/vulnerable-flask/python-app:1.0.0
    - trivy --insecure --scanners vuln --format cyclonedx --output build.json image vulnerable-flask/python-app:1.0.0
  artifacts:
    paths:
      - build.json
